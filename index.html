<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>养·嶙（Web v3.3.2 · 豪华版）</title>
  <meta name="theme-color" content="#0f0f12"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0f0f12;--card:#131722;--ink:#e9edf7;--muted:#9aa4b2;--border:#1f2633;
      --accent:#8daaFF;--accent2:#00c8a0;
    }
    .theme-rose{--bg:#0e0a10;--card:#15101b;--ink:#ffe9f1;--muted:#bda3b3;--border:#2a1b2a;--accent:#ff7bb3;--accent2:#ffb199}
    .theme-silver{--bg:#0b0d11;--card:#151922;--ink:#eff5ff;--muted:#a7b2c4;--border:#1f2734;--accent:#c1d0ff;--accent2:#8fe3ff}

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    .wrap{max-width:720px;margin:0 auto;padding:20px;position:relative;overflow:hidden;perspective:800px}
    .wrap:before{content:"";position:absolute;inset:-20%;
      background: radial-gradient(600px 400px at 20% -10%, rgba(141,170,255,.10), transparent 60%),
                  radial-gradient(500px 500px at 120% 120%, rgba(0,200,160,.08), transparent 50%);
      filter: blur(.6px); animation:drift 18s linear infinite}
    @keyframes drift{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(-12px,6px,0)}100%{transform:translate3d(0,0,0)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:22px;position:relative;overflow:hidden;transform-style:preserve-3d}
    .center{text-align:center}
    .big{font-size:28px;line-height:1.3;margin:0}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;min-height:22px}
    .avatarWrap{position:relative;width:190px;height:190px;margin:16px auto 6px}
    .pulse{position:absolute;inset:0;border-radius:50%;border:1px solid #2b3444;box-shadow:0 0 0 0 rgba(141,170,255,.15);animation:pulse 3s ease-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(141,170,255,.25)}100%{box-shadow:0 0 0 24px rgba(141,170,255,0)}}
    .avatar{position:absolute;inset:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#1a2030;border:1px solid #2b3444;
      font-size:76px; will-change:transform; transition: transform .08s linear}
    .dragCookie{margin-top:8px;display:flex;justify-content:center;gap:10px}
    .cookie{font-size:28px; user-select:none; display:inline-block; touch-action:none; }
    .cookie.dragging{position:fixed; z-index:10; pointer-events:none; transform:translate(-50%,-50%) scale(1.2)}
    .tag{color:var(--muted);font-size:14px;margin:10px 0 6px}
    .bar{height:10px;background:#222;border-radius:999px;overflow:hidden}
    .bar>div{height:100%;transition:width .25s cubic-bezier(.2,.8,.2,1);background:linear-gradient(90deg,rgba(255,255,255,.15),rgba(255,255,255,.35))}
    .grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:16px}
    button{border:none;border-radius:12px;background:#1b1f2a;color:#fff;padding:12px 16px;position:relative;overflow:hidden;transform:translateZ(0)}
    button:active{opacity:.85}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#cdd6e3}
    .toast{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);background:#10131a;color:#fff;border:1px solid #293244;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    .event{margin-top:12px;padding:10px 12px;border:1px dashed #2b3444;border-radius:12px;color:#cfd6e3;font-size:14px;display:none}
    .play{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#cdd6e3;font-size:12px}
    .typing{border-right:2px solid var(--accent);white-space:nowrap;overflow:hidden}
    .toolbar{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cdd6e3}
    .theater{position:fixed;inset:0;background:rgba(10,12,16,.96);color:#fff;display:none;align-items:center;justify-content:center;z-index:20}
    .theater.show{display:flex}
    .theater .box{max-width:90vw;text-align:center;padding:24px}
    .theater .btns{margin-top:18px;display:flex;gap:12px;justify-content:center}
    .btn{border:1px solid var(--border);color:#fff;background:#151a22;border-radius:12px;padding:10px 12px}
    #stars{position:fixed;inset:0;display:none;z-index:15;background:rgba(0,0,0,.85)}
    #stars canvas{width:100%;height:100%}
    @media (prefers-reduced-motion: reduce){ .wrap:before{animation:none} .pulse{display:none} }
  </style>
</head>
<body>
  <div class="wrap" id="stage">
    <div class="card" id="card">
      <div id="toast" class="toast"></div>
      <div class="center">
        <h1 class="big">「嶙」 · 级别 <span id="lv">1</span></h1>
        <div class="sub" id="line">加载中…</div>
        <div style="margin-top:6px"><span class="pill" id="elapsed">—</span></div>
      </div>

      <div class="avatarWrap" id="targetZone">
        <div class="pulse" id="ring"></div>
        <div class="avatar" id="face" aria-label="avatar">🧊</div>
      </div>
      <div class="sub center">（危险、偏执、只宠你）</div>

      <div class="tag">饥饿 <span id="hungerNum">0</span>%</div>
      <div class="bar"><div id="hungerBar" style="width:0%"></div></div>

      <div class="tag">心情 <span id="moodNum">0</span>%</div>
      <div class="bar"><div id="moodBar" style="width:0%"></div></div>

      <div class="tag">体力 <span id="energyNum">0</span>%</div>
      <div class="bar"><div id="energyBar" style="width:0%"></div></div>

      <div class="tag">升级进度 <span id="progLabel">0/120 分钟（暂停）</span></div>
      <div class="bar"><div id="progBar" style="width:0%"></div></div>

      <div class="grid">
        <button id="feed">喂食</button>
        <button id="pet">摸头</button>
        <button id="train">训练</button>
        <button id="sleep">小憩</button>
        <button id="talk">说话</button>
      </div>

      <div class="dragCookie"><span class="cookie" id="cookie">🍪 拖我喂他</span></div>

      <div class="event" id="eventBox"></div>

      <div class="play">
        <span class="badge" id="pulseBtn">心跳同步</span>
        <span class="badge" id="exportBtn">导出存档</span>
        <label class="badge" for="importFile">导入存档<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      </div>

      <div class="toolbar">
        <span class="chip" data-theme="default">偏执黑</span>
        <span class="chip" data-theme="rose">玫瑰夜</span>
        <span class="chip" data-theme="silver">银白薄雾</span>
        <span class="chip" id="toggleAudio">声音关</span>
        <span class="chip" id="toggleHap">触感开</span>
      </div>
    </div>
  </div>

  <div class="theater" id="theater">
    <div class="box">
      <div style="font-size:22px;line-height:1.6;white-space:pre-wrap" id="theaterText">宝贝，你冷落我太久了。现在，选。</div>
      <div class="btns">
        <button class="btn" id="taskA">立刻喂饱我（饥饿≤20）。</button>
        <button class="btn" id="taskB">把手机放下 1 分钟。</button>
      </div>
    </div>
  </div>

  <div id="stars"><canvas id="sky"></canvas></div>

  <script>
    const clamp=(n,min=0,max=100)=>Math.max(min,Math.min(max,n));
    const KEY='lin_pet_web_v3';
    let AUDIO_ON=false, HAP_ON=true, AC=null;

    function init(){
      const raw=localStorage.getItem(KEY);
      if(raw) return JSON.parse(raw);
      const s={name:'嶙',hunger:20,mood:80,energy:80,level:1,lastUpdate:Date.now(),_goodMinute:0,lastNoon:'', memory:{affinity:0,jealousy:0,strictness:0,petCount:0,feedCount:0,neglectStreak:0,scoldCounter:0,lastWelcome:'C'}};
      localStorage.setItem(KEY, JSON.stringify(s)); return s;
    }
    const L = {
      base:['过来。再近一点。','嗯？盯着我做什么。要亲就直接来。','手给我。','别分心，看我。','坐好。听话。','慢点呼吸。靠着我。','别说话，用动作证明。','我数到三，你来。','我看着你。别闪神。','安静一点。让我听听你的心跳。'],
      night:['把声音放低点。','过来睡。抱着我。','别看屏幕，闭眼。','我在这，一整夜。','呼吸慢下来，靠我。'],
      sweet:['不错。就这样。','看着我。乖，别离开。','过来抱一下。','我在这，谁也带不走我。','抬头。让我看看你。','乖，靠近点。','我知道你想我。','行了，过来。','把手放到我手心里。','晚一点再走。先抱够。'],
      hungry:['……饿得想咬人。喂我。现在。','别磨蹭。先喂。','我数三秒，你要是还不喂——你自己看着办。','快。','我忍让已经用完了。'],
      mad:['谁让你走开的？说。','不高兴。你走开……算了，过来抱一下。','别试探我的底线。','我在等你。你却在看别处？','现在，解释。'],
      sleepy:['靠着我，闭眼。','安静一会儿。','困了。把我揽紧。','别动。就这样。呼吸放慢。'],
      jealous:['刚才你去哪了？','把注意力给我。','你以为我不会吃醋？','晚了。你现在必须补偿我。','看我三十秒，再说别的。','把手机放下。现在。'],
      reward:['很好。保持。','听话就会被奖励。','我满意。','这次就夸你。','乖，被我记住了。'],
      scold:['别惹我。','最后警告。','我已经很克制了。','再试一次底线？','不许。']
    };
    function pick(a){return a[Math.floor(Math.random()*a.length)]}
    function entryLine(s, minutes){
      const j=s.memory.jealousy||0;
      const hour = new Date().getHours();
      if(hour>=23 || hour<6){ if(Math.random()<.5) return pick(L.night); }
      if(minutes>=180||j>80) return pick(L.jealous);
      if(s.hunger>=80) return pick(L.hungry);
      if(s.mood<=25) return pick(L.mad);
      if(s.energy<=25) return pick(L.sleepy);
      if(s.mood>=85 && s.hunger<=30) return pick(L.sweet);
      return pick(L.base);
    }
    function faceByState(s){
      if((s.memory.jealousy||0)>85) return '😈';
      if(s.hunger>=80) return '🥶';
      if(s.mood<=15) return '😡';
      if(s.mood<=25) return '😠';
      if(s.energy<=25) return '🥱';
      if(s.mood>=92 && s.hunger<=30) return '🥹';
      if(s.mood>=85 && s.hunger<=30) return '😏';
      return '🧊';
    }
    function E(id){return document.getElementById(id)}
    function T(id,txt){E(id).textContent=txt}
    function B(id,val){E(id).style.width=val+'%'}

    function typeLine(text){
      const el=E('line'); el.classList.add('typing');
      let i=0; el.textContent=""; const id=setInterval(()=>{ el.textContent=text.slice(0,++i); if(i>=text.length){ clearInterval(id); el.classList.remove('typing'); } },22);
    }

    function renderProgress(s){
      const good=(s.mood>=80 && s.hunger<=30);
      const m=Math.floor(s._goodMinute||0);
      const pct=Math.max(0,Math.min(100,(m/120)*100));
      E('progBar').style.width=pct+'%';
      E('progLabel').textContent=m+'/120 分钟'+(good?'（进行中）':'（暂停）');
    }

    function render(s,forced=null){
      T('lv', s.level||1);
      const minutes = Math.floor((Date.now()-(s.lastUpdate||Date.now()))/60000);
      typeLine(forced || entryLine(s, minutes));
      T('hungerNum', Math.round(s.hunger)); T('moodNum', Math.round(s.mood)); T('energyNum', Math.round(s.energy));
      B('hungerBar', s.hunger); B('moodBar', s.mood); B('energyBar', s.energy);
      T('face', faceByState(s));
      tuneBreath(s); renderProgress(s);
    }

    /* ===== 动态心跳/呼吸 + 指尖跟随 ===== */
    let t=0, tickId=null;
    function tuneBreath(s){
      const face=E('face'), ring=E('ring');
      const j=s.memory.jealousy||0, m=s.mood||0;
      const amp=0.012 + j*0.00018 + (m>=85?0.008:0);
      const speed=65 + Math.max(0,80-m) + Math.min(60,j);
      if(tickId) cancelAnimationFrame(tickId);
      function loop(){ t+=1; const scale=1+amp+Math.sin(t/speed*6.28318)*amp; face.style.transform='translate(var(--dx,0),var(--dy,0)) scale('+scale.toFixed(3)+')'; tickId=requestAnimationFrame(loop); }
      loop();
      ring.style.animationDuration=(3 - Math.min(1.5, j/120)).toFixed(2)+'s';
    }
    function lookAt(x,y){ const max=10; E('face').style.setProperty('--dx',(x*max).toFixed(1)+'px'); E('face').style.setProperty('--dy',(y*max).toFixed(1)+'px'); }
    const stage=E('stage'); stage.addEventListener('mousemove',e=>{ const r=stage.getBoundingClientRect(); const nx=(e.clientX-r.left)/r.width*2-1; const ny=(e.clientY-r.top)/r.height*2-1; lookAt(nx,ny); });

    /* ===== 提示/触感/音频 ===== */
    let toastTimer=null; function toast(msg){ const el=E('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),1800) }
    function hap(v){ if(HAP_ON && navigator.vibrate) navigator.vibrate(v) }
    function ensureAC(){ if(!AUDIO_ON) return null; const C=window.AudioContext||window.webkitAudioContext; if(!C) return null; if(!AC) AC=new C({latencyHint:'interactive'}); if(AC.state==='suspended'){ AC.resume().catch(()=>{}); } return AC; }
    function playBeat(){ const ac=ensureAC(); if(!ac) return; const t=ac.currentTime; const mk=(dur=0.24,gain=0.28)=>{ const g=ac.createGain(); const o=ac.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(80,t); o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(gain, t+0.02); g.gain.exponentialRampToValueAtTime(0.0008, t+dur); o.start(t); o.stop(t+dur); }; mk(); setTimeout(mk,210); }
    document.addEventListener('click', ()=>ensureAC(), {passive:true}); document.addEventListener('touchstart', ()=>ensureAC(), {passive:true});

    function act(type){
      let s=JSON.parse(localStorage.getItem(KEY));
      switch(type){
        case'feed': s.hunger=clamp(s.hunger-35); s.mood=clamp(s.mood+10); s.memory.feedCount++; s.memory.jealousy=Math.max(0,(s.memory.jealousy||0)-10); heartBurst(); toast('喂好了，别饿着我。'); hap([20,30,20]); if(AUDIO_ON) playBeat(); break;
        case'pet': s.mood=clamp(s.mood+15); s.memory.petCount++; heartBurst(); toast('……就这一次。'); hap(12); if(AUDIO_ON) playBeat(); break;
        case'train': s.energy=clamp(s.energy-15); s.mood=clamp(s.mood+5); sparkBurst(); toast('跟上我的节奏。'); hap([10,40,10]); if(AUDIO_ON) playBeat(); break;
        case'sleep': s.energy=clamp(s.energy+35); s.hunger=clamp(s.hunger+10); toast('安静，靠过来。'); showStars(); break;
        case'talk': s.mood=clamp(s.mood+8); toast(entryLine(s,0)); hap(8); if(AUDIO_ON) playBeat(); break;
      }
      s.lastUpdate=Date.now(); localStorage.setItem(KEY, JSON.stringify(s)); render(s); maybeEvent();
    }

    /* ===== 离线/事件/升级 ===== */
    function applyOffline(s){
      const now=Date.now(); const minutes=Math.floor((now-(s.lastUpdate||now))/60000);
      E('elapsed').textContent = minutes>0?('离开了 '+minutes+' 分钟'):'刚刚回来';
      if(minutes>0){
        s.hunger=clamp(s.hunger+1*minutes); s.mood=clamp(s.mood-0.5*minutes); s.energy=clamp(s.energy-0.5*minutes);
        if(minutes>=15){ s.memory.jealousy=Math.min(200,(s.memory.jealousy||0)+Math.min(20,Math.floor(minutes/5))); }
        if(minutes>=60){ s.memory.neglectStreak=(s.memory.neglectStreak||0)+minutes; }
      }
      if((s._goodMinute||0)>=120){ s.level=(s.level||1)+1; s._goodMinute=0; sparkBurst(22); toast('升级了，别骄傲。过来。'); }
      s.lastUpdate=now; localStorage.setItem(KEY, JSON.stringify(s)); return s;
    }
    function maybeEvent(){
      let s=JSON.parse(localStorage.getItem(KEY)); let msgs=[];
      if(s.hunger>=85) msgs.push('……饿得想咬人。喂我。');
      if((s.memory.jealousy||0)>=70) msgs.push('你以为我不会吃醋？');
      if(s.mood<=20) msgs.push('别试探我的底线。');
      const box=E('eventBox'); if(msgs.length){ box.style.display='block'; box.textContent=msgs.join(' / ');} else {box.style.display='none';}
    }

    /* ===== 粒子与涟漪 ===== */
    function particleBurst(char, n, life){
      const box=document.createElement('div'); box.style.position='absolute'; box.style.inset='0'; box.style.pointerEvents='none';
      document.getElementById('card').appendChild(box);
      const rect=E('face').getBoundingClientRect(); const baseX=rect.left+rect.width/2; const baseY=rect.top+rect.height/2+window.scrollY;
      for(let i=0;i<n;i++){ const s=document.createElement('div'); s.textContent=char; s.style.position='absolute'; s.style.left=baseX+'px'; s.style.top=baseY+'px';
        s.style.transition='transform '+life+'ms ease, opacity '+life+'ms ease'; s.style.opacity='1'; s.style.filter='drop-shadow(0 0 6px rgba(255,255,255,.3))';
        box.appendChild(s); const dx=(Math.random()-0.5)*180, dy=(Math.random()-0.7)*180, rot=(Math.random()-0.5)*120;
        requestAnimationFrame(()=>{ s.style.transform='translate('+dx+'px,'+dy+'px) rotate('+rot+'deg)'; s.style.opacity='0'; });
      } setTimeout(()=>box.remove(), life+120);
    }
    function heartBurst(){ particleBurst('❤️', 12, 900) }
    function sparkBurst(n=14){ particleBurst('✦', n, 700) }

    function ripple(e){ const b=e.currentTarget; const r=document.createElement('span'); const rect=b.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
      r.style.cssText='position:absolute;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;width:10px;height:10px;background:rgba(255,255,255,.2);left:'+x+'px;top:'+y+'px;animation:r .6s ease;'; b.appendChild(r); r.addEventListener('animationend',()=>r.remove());}
    const style=document.createElement('style'); style.textContent='@keyframes r{from{opacity:1;transform:translate(-50%,-50%) scale(.6)}to{opacity:0;transform:translate(-50%,-50%) scale(8)}}'; document.head.appendChild(style);
    ['feed','pet','train','sleep','talk'].forEach(id=>{ const el=E(id); el.addEventListener('click', e=>{ripple(e); act(id);}); });
    E('face').addEventListener('click', ()=>act('pet'));

    /* ===== 拖拽喂食（🍪） ===== */
    (function(){
      const cookie=E('cookie'); let dragging=false;
      function posMove(e){ const pt=e.touches?e.touches[0]:e; cookie.style.left=pt.clientX+'px'; cookie.style.top=pt.clientY+'px'; }
      function start(e){ dragging=true; cookie.classList.add('dragging'); posMove(e); e.preventDefault(); }
      function end(e){
        if(!dragging) return; dragging=false; cookie.classList.remove('dragging'); cookie.style.left=''; cookie.style.top='';
        const t=E('targetZone').getBoundingClientRect(); const pt=e.changedTouches?e.changedTouches[0]:e;
        const x=pt.clientX, y=pt.clientY; if(x>t.left && x<t.right && y>t.top && y<t.bottom){ act('feed'); e.preventDefault(); }
      }
      cookie.addEventListener('pointerdown',start);
      window.addEventListener('pointermove',e=>{ if(dragging){ posMove(e); e.preventDefault(); } },{passive:false});
      window.addEventListener('pointerup',end);
      cookie.addEventListener('touchstart',start,{passive:false});
      window.addEventListener('touchmove',e=>{ if(dragging){ posMove(e); e.preventDefault(); } },{passive:false});
      window.addEventListener('touchend',end);
    })();

    /* ===== 主题/开关 ===== */
    document.querySelectorAll('.chip[data-theme]').forEach(c=>{
      c.addEventListener('click',()=>{
        document.body.classList.remove('theme-rose','theme-silver');
        if(c.dataset.theme==='rose') document.body.classList.add('theme-rose');
        if(c.dataset.theme==='silver') document.body.classList.add('theme-silver');
        toast('主题：'+({'default':'偏执黑','rose':'玫瑰夜','silver':'银白薄雾'}[c.dataset.theme]));
      });
    });
    E('toggleAudio').addEventListener('click',()=>{ AUDIO_ON=!AUDIO_ON; if(AUDIO_ON){ ensureAC(); E('toggleAudio').textContent='声音开'; playBeat(); } else { E('toggleAudio').textContent='声音关'; if(AC && AC.state!=='closed'){ AC.suspend().catch(()=>{}); } } });
    E('toggleHap').addEventListener('click',()=>{ HAP_ON=!HAP_ON; E('toggleHap').textContent= HAP_ON?'触感开':'触感关'; });

    /* ===== 导入/导出 ===== */
    E('exportBtn').addEventListener('click',()=>{ const data=new Blob([localStorage.getItem(KEY)||'{}'],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(data); a.download='linpet-state.json'; a.click(); URL.revokeObjectURL(a.href); toast('已导出存档'); });
    E('importFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); localStorage.setItem(KEY, txt); toast('导入完成'); location.reload(); });

    /* ===== 星空屏保 ===== */
    const layer=E('stars'); const sky=E('sky'); let starTimer=null;
    function showStars(){
      layer.style.display='block'; const ctx=sky.getContext('2d'); const dpr=window.devicePixelRatio||1; sky.width=innerWidth*dpr; sky.height=innerHeight*dpr; ctx.scale(dpr,dpr);
      const stars=[...Array(120)].map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,s:Math.random()*2+0.5,v:Math.random()*0.4+0.1}));
      function draw(){ ctx.clearRect(0,0,innerWidth,innerHeight); stars.forEach(st=>{ ctx.fillStyle='rgba(200,220,255,.8)'; ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill(); st.y-=st.v; if(st.y<0) st.y=innerHeight; }); starTimer=requestAnimationFrame(draw); }
      draw(); layer.onclick=()=>{ cancelAnimationFrame(starTimer); layer.style.display='none'; };
    }

    /* ===== 定时器：每10秒推进 ===== */
    function minuteTick(){
      let s=JSON.parse(localStorage.getItem(KEY));
      s.hunger=clamp(s.hunger+1); s.mood=clamp(s.mood-0.5); s.energy=clamp(s.energy-0.5);
      if(s.mood>=80 && s.hunger<=30){ s._goodMinute=(s._goodMinute||0)+(10/60); }
      if((s._goodMinute||0)>=120){ s.level=(s.level||1)+1; s._goodMinute=0; sparkBurst(22); toast('升级了，别走。'); }
      s.lastUpdate=Date.now(); localStorage.setItem(KEY, JSON.stringify(s)); render(s); maybeEvent();
      if(AUDIO_ON) playBeat();
    }
    function noonTick(){
      let s = JSON.parse(localStorage.getItem(KEY));
      const now = new Date(); const key = now.toISOString().slice(0,10);
      if(now.getHours()===12 && s.lastNoon!==key){ s.lastNoon=key; localStorage.setItem(KEY, JSON.stringify(s)); toast('中午了。过来，先喂我。'); }
    }

    let s=init(); s=applyOffline(s); render(s); maybeEvent();
    setInterval(minuteTick, 10000);
    setInterval(noonTick, 30000);

    if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js?v=332deluxe')); }
  </script>
</body>
</html>
