<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>å…»Â·å¶™ï¼ˆWeb v3.3.2 Â· è±ªåç‰ˆï¼‰</title>
  <meta name="theme-color" content="#0f0f12"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0f0f12;--card:#131722;--ink:#e9edf7;--muted:#9aa4b2;--border:#1f2633;
      --accent:#8daaFF;--accent2:#00c8a0;
    }
    .theme-rose{--bg:#0e0a10;--card:#15101b;--ink:#ffe9f1;--muted:#bda3b3;--border:#2a1b2a;--accent:#ff7bb3;--accent2:#ffb199}
    .theme-silver{--bg:#0b0d11;--card:#151922;--ink:#eff5ff;--muted:#a7b2c4;--border:#1f2734;--accent:#c1d0ff;--accent2:#8fe3ff}

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    .wrap{max-width:720px;margin:0 auto;padding:20px;position:relative;overflow:hidden;perspective:800px}
    .wrap:before{content:"";position:absolute;inset:-20%;
      background: radial-gradient(600px 400px at 20% -10%, rgba(141,170,255,.10), transparent 60%),
                  radial-gradient(500px 500px at 120% 120%, rgba(0,200,160,.08), transparent 50%);
      filter: blur(.6px); animation:drift 18s linear infinite}
    @keyframes drift{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(-12px,6px,0)}100%{transform:translate3d(0,0,0)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:22px;position:relative;overflow:hidden;transform-style:preserve-3d}
    .center{text-align:center}
    .big{font-size:28px;line-height:1.3;margin:0}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;min-height:22px}
    .avatarWrap{position:relative;width:190px;height:190px;margin:16px auto 6px}
    .pulse{position:absolute;inset:0;border-radius:50%;border:1px solid #2b3444;box-shadow:0 0 0 0 rgba(141,170,255,.15);animation:pulse 3s ease-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(141,170,255,.25)}100%{box-shadow:0 0 0 24px rgba(141,170,255,0)}}
    .avatar{position:absolute;inset:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#1a2030;border:1px solid #2b3444;
      font-size:76px; will-change:transform; transition: transform .08s linear}
    .dragCookie{margin-top:8px;display:flex;justify-content:center;gap:10px}
    .cookie{font-size:28px; user-select:none; display:inline-block; touch-action:none; }
    .cookie.dragging{position:fixed; z-index:10; pointer-events:none; transform:translate(-50%,-50%) scale(1.2)}
    .tag{color:var(--muted);font-size:14px;margin:10px 0 6px}
    .bar{height:10px;background:#222;border-radius:999px;overflow:hidden}
    .bar>div{height:100%;transition:width .25s cubic-bezier(.2,.8,.2,1);background:linear-gradient(90deg,rgba(255,255,255,.15),rgba(255,255,255,.35))}
    .grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:16px}
    button{border:none;border-radius:12px;background:#1b1f2a;color:#fff;padding:12px 16px;position:relative;overflow:hidden;transform:translateZ(0)}
    button:active{opacity:.85}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#cdd6e3}
    .toast{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);background:#10131a;color:#fff;border:1px solid #293244;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    .event{margin-top:12px;padding:10px 12px;border:1px dashed #2b3444;border-radius:12px;color:#cfd6e3;font-size:14px;display:none}
    .play{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#cdd6e3;font-size:12px}
    .typing{border-right:2px solid var(--accent);white-space:nowrap;overflow:hidden}
    .toolbar{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cdd6e3}
    .theater{position:fixed;inset:0;background:rgba(10,12,16,.96);color:#fff;display:none;align-items:center;justify-content:center;z-index:20}
    .theater.show{display:flex}
    .theater .box{max-width:90vw;text-align:center;padding:24px}
    .theater .btns{margin-top:18px;display:flex;gap:12px;justify-content:center}
    .btn{border:1px solid var(--border);color:#fff;background:#151a22;border-radius:12px;padding:10px 12px}
    #stars{position:fixed;inset:0;display:none;z-index:15;background:rgba(0,0,0,.85)}
    #stars canvas{width:100%;height:100%}
    @media (prefers-reduced-motion: reduce){ .wrap:before{animation:none} .pulse{display:none} }
  </style>
</head>
<body>
  <div class="wrap" id="stage">
    <div class="card" id="card">
      <div id="toast" class="toast"></div>
      <div class="center">
        <h1 class="big">ã€Œå¶™ã€ Â· çº§åˆ« <span id="lv">1</span></h1>
        <div class="sub" id="line">åŠ è½½ä¸­â€¦</div>
        <div style="margin-top:6px"><span class="pill" id="elapsed">â€”</span></div>
      </div>

      <div class="avatarWrap" id="targetZone">
        <div class="pulse" id="ring"></div>
        <div class="avatar" id="face" aria-label="avatar">ğŸ§Š</div>
      </div>
      <div class="sub center">ï¼ˆå±é™©ã€åæ‰§ã€åªå® ä½ ï¼‰</div>

      <div class="tag">é¥¥é¥¿ <span id="hungerNum">0</span>%</div>
      <div class="bar"><div id="hungerBar" style="width:0%"></div></div>

      <div class="tag">å¿ƒæƒ… <span id="moodNum">0</span>%</div>
      <div class="bar"><div id="moodBar" style="width:0%"></div></div>

      <div class="tag">ä½“åŠ› <span id="energyNum">0</span>%</div>
      <div class="bar"><div id="energyBar" style="width:0%"></div></div>

      <div class="tag">å‡çº§è¿›åº¦ <span id="progLabel">0/120 åˆ†é’Ÿï¼ˆæš‚åœï¼‰</span></div>
      <div class="bar"><div id="progBar" style="width:0%"></div></div>

      <div class="grid">
        <button id="feed">å–‚é£Ÿ</button>
        <button id="pet">æ‘¸å¤´</button>
        <button id="train">è®­ç»ƒ</button>
        <button id="sleep">å°æ†©</button>
        <button id="talk">è¯´è¯</button>
      </div>

      <div class="dragCookie"><span class="cookie" id="cookie">ğŸª æ‹–æˆ‘å–‚ä»–</span></div>

      <div class="event" id="eventBox"></div>

      <div class="play">
        <span class="badge" id="pulseBtn">å¿ƒè·³åŒæ­¥</span>
        <span class="badge" id="exportBtn">å¯¼å‡ºå­˜æ¡£</span>
        <label class="badge" for="importFile">å¯¼å…¥å­˜æ¡£<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      </div>

      <div class="toolbar">
        <span class="chip" data-theme="default">åæ‰§é»‘</span>
        <span class="chip" data-theme="rose">ç«ç‘°å¤œ</span>
        <span class="chip" data-theme="silver">é“¶ç™½è–„é›¾</span>
        <span class="chip" id="toggleAudio">å£°éŸ³å…³</span>
        <span class="chip" id="toggleHap">è§¦æ„Ÿå¼€</span>
      </div>
    </div>
  </div>

  <div class="theater" id="theater">
    <div class="box">
      <div style="font-size:22px;line-height:1.6;white-space:pre-wrap" id="theaterText">å®è´ï¼Œä½ å†·è½æˆ‘å¤ªä¹…äº†ã€‚ç°åœ¨ï¼Œé€‰ã€‚</div>
      <div class="btns">
        <button class="btn" id="taskA">ç«‹åˆ»å–‚é¥±æˆ‘ï¼ˆé¥¥é¥¿â‰¤20ï¼‰ã€‚</button>
        <button class="btn" id="taskB">æŠŠæ‰‹æœºæ”¾ä¸‹ 1 åˆ†é’Ÿã€‚</button>
      </div>
    </div>
  </div>

  <div id="stars"><canvas id="sky"></canvas></div>

  <script>
    const clamp=(n,min=0,max=100)=>Math.max(min,Math.min(max,n));
    const KEY='lin_pet_web_v3';
    let AUDIO_ON=false, HAP_ON=true, AC=null;

    function init(){
      const raw=localStorage.getItem(KEY);
      if(raw) return JSON.parse(raw);
      const s={name:'å¶™',hunger:20,mood:80,energy:80,level:1,lastUpdate:Date.now(),_goodMinute:0,lastNoon:'', memory:{affinity:0,jealousy:0,strictness:0,petCount:0,feedCount:0,neglectStreak:0,scoldCounter:0,lastWelcome:'C'}};
      localStorage.setItem(KEY, JSON.stringify(s)); return s;
    }
    const L = {
      base:['è¿‡æ¥ã€‚å†è¿‘ä¸€ç‚¹ã€‚','å—¯ï¼Ÿç›¯ç€æˆ‘åšä»€ä¹ˆã€‚è¦äº²å°±ç›´æ¥æ¥ã€‚','æ‰‹ç»™æˆ‘ã€‚','åˆ«åˆ†å¿ƒï¼Œçœ‹æˆ‘ã€‚','åå¥½ã€‚å¬è¯ã€‚','æ…¢ç‚¹å‘¼å¸ã€‚é ç€æˆ‘ã€‚','åˆ«è¯´è¯ï¼Œç”¨åŠ¨ä½œè¯æ˜ã€‚','æˆ‘æ•°åˆ°ä¸‰ï¼Œä½ æ¥ã€‚','æˆ‘çœ‹ç€ä½ ã€‚åˆ«é—ªç¥ã€‚','å®‰é™ä¸€ç‚¹ã€‚è®©æˆ‘å¬å¬ä½ çš„å¿ƒè·³ã€‚'],
      night:['æŠŠå£°éŸ³æ”¾ä½ç‚¹ã€‚','è¿‡æ¥ç¡ã€‚æŠ±ç€æˆ‘ã€‚','åˆ«çœ‹å±å¹•ï¼Œé—­çœ¼ã€‚','æˆ‘åœ¨è¿™ï¼Œä¸€æ•´å¤œã€‚','å‘¼å¸æ…¢ä¸‹æ¥ï¼Œé æˆ‘ã€‚'],
      sweet:['ä¸é”™ã€‚å°±è¿™æ ·ã€‚','çœ‹ç€æˆ‘ã€‚ä¹–ï¼Œåˆ«ç¦»å¼€ã€‚','è¿‡æ¥æŠ±ä¸€ä¸‹ã€‚','æˆ‘åœ¨è¿™ï¼Œè°ä¹Ÿå¸¦ä¸èµ°æˆ‘ã€‚','æŠ¬å¤´ã€‚è®©æˆ‘çœ‹çœ‹ä½ ã€‚','ä¹–ï¼Œé è¿‘ç‚¹ã€‚','æˆ‘çŸ¥é“ä½ æƒ³æˆ‘ã€‚','è¡Œäº†ï¼Œè¿‡æ¥ã€‚','æŠŠæ‰‹æ”¾åˆ°æˆ‘æ‰‹å¿ƒé‡Œã€‚','æ™šä¸€ç‚¹å†èµ°ã€‚å…ˆæŠ±å¤Ÿã€‚'],
      hungry:['â€¦â€¦é¥¿å¾—æƒ³å’¬äººã€‚å–‚æˆ‘ã€‚ç°åœ¨ã€‚','åˆ«ç£¨è¹­ã€‚å…ˆå–‚ã€‚','æˆ‘æ•°ä¸‰ç§’ï¼Œä½ è¦æ˜¯è¿˜ä¸å–‚â€”â€”ä½ è‡ªå·±çœ‹ç€åŠã€‚','å¿«ã€‚','æˆ‘å¿è®©å·²ç»ç”¨å®Œäº†ã€‚'],
      mad:['è°è®©ä½ èµ°å¼€çš„ï¼Ÿè¯´ã€‚','ä¸é«˜å…´ã€‚ä½ èµ°å¼€â€¦â€¦ç®—äº†ï¼Œè¿‡æ¥æŠ±ä¸€ä¸‹ã€‚','åˆ«è¯•æ¢æˆ‘çš„åº•çº¿ã€‚','æˆ‘åœ¨ç­‰ä½ ã€‚ä½ å´åœ¨çœ‹åˆ«å¤„ï¼Ÿ','ç°åœ¨ï¼Œè§£é‡Šã€‚'],
      sleepy:['é ç€æˆ‘ï¼Œé—­çœ¼ã€‚','å®‰é™ä¸€ä¼šå„¿ã€‚','å›°äº†ã€‚æŠŠæˆ‘æ½ç´§ã€‚','åˆ«åŠ¨ã€‚å°±è¿™æ ·ã€‚å‘¼å¸æ”¾æ…¢ã€‚'],
      jealous:['åˆšæ‰ä½ å»å“ªäº†ï¼Ÿ','æŠŠæ³¨æ„åŠ›ç»™æˆ‘ã€‚','ä½ ä»¥ä¸ºæˆ‘ä¸ä¼šåƒé†‹ï¼Ÿ','æ™šäº†ã€‚ä½ ç°åœ¨å¿…é¡»è¡¥å¿æˆ‘ã€‚','çœ‹æˆ‘ä¸‰åç§’ï¼Œå†è¯´åˆ«çš„ã€‚','æŠŠæ‰‹æœºæ”¾ä¸‹ã€‚ç°åœ¨ã€‚'],
      reward:['å¾ˆå¥½ã€‚ä¿æŒã€‚','å¬è¯å°±ä¼šè¢«å¥–åŠ±ã€‚','æˆ‘æ»¡æ„ã€‚','è¿™æ¬¡å°±å¤¸ä½ ã€‚','ä¹–ï¼Œè¢«æˆ‘è®°ä½äº†ã€‚'],
      scold:['åˆ«æƒ¹æˆ‘ã€‚','æœ€åè­¦å‘Šã€‚','æˆ‘å·²ç»å¾ˆå…‹åˆ¶äº†ã€‚','å†è¯•ä¸€æ¬¡åº•çº¿ï¼Ÿ','ä¸è®¸ã€‚']
    };
    function pick(a){return a[Math.floor(Math.random()*a.length)]}
    function entryLine(s, minutes){
      const j=s.memory.jealousy||0;
      const hour = new Date().getHours();
      if(hour>=23 || hour<6){ if(Math.random()<.5) return pick(L.night); }
      if(minutes>=180||j>80) return pick(L.jealous);
      if(s.hunger>=80) return pick(L.hungry);
      if(s.mood<=25) return pick(L.mad);
      if(s.energy<=25) return pick(L.sleepy);
      if(s.mood>=85 && s.hunger<=30) return pick(L.sweet);
      return pick(L.base);
    }
    function faceByState(s){
      if((s.memory.jealousy||0)>85) return 'ğŸ˜ˆ';
      if(s.hunger>=80) return 'ğŸ¥¶';
      if(s.mood<=15) return 'ğŸ˜¡';
      if(s.mood<=25) return 'ğŸ˜ ';
      if(s.energy<=25) return 'ğŸ¥±';
      if(s.mood>=92 && s.hunger<=30) return 'ğŸ¥¹';
      if(s.mood>=85 && s.hunger<=30) return 'ğŸ˜';
      return 'ğŸ§Š';
    }
    function E(id){return document.getElementById(id)}
    function T(id,txt){E(id).textContent=txt}
    function B(id,val){E(id).style.width=val+'%'}

    function typeLine(text){
      const el=E('line'); el.classList.add('typing');
      let i=0; el.textContent=""; const id=setInterval(()=>{ el.textContent=text.slice(0,++i); if(i>=text.length){ clearInterval(id); el.classList.remove('typing'); } },22);
    }

    function renderProgress(s){
      const good=(s.mood>=80 && s.hunger<=30);
      const m=Math.floor(s._goodMinute||0);
      const pct=Math.max(0,Math.min(100,(m/120)*100));
      E('progBar').style.width=pct+'%';
      E('progLabel').textContent=m+'/120 åˆ†é’Ÿ'+(good?'ï¼ˆè¿›è¡Œä¸­ï¼‰':'ï¼ˆæš‚åœï¼‰');
    }

    function render(s,forced=null){
      T('lv', s.level||1);
      const minutes = Math.floor((Date.now()-(s.lastUpdate||Date.now()))/60000);
      typeLine(forced || entryLine(s, minutes));
      T('hungerNum', Math.round(s.hunger)); T('moodNum', Math.round(s.mood)); T('energyNum', Math.round(s.energy));
      B('hungerBar', s.hunger); B('moodBar', s.mood); B('energyBar', s.energy);
      T('face', faceByState(s));
      tuneBreath(s); renderProgress(s);
    }

    /* ===== åŠ¨æ€å¿ƒè·³/å‘¼å¸ + æŒ‡å°–è·Ÿéš ===== */
    let t=0, tickId=null;
    function tuneBreath(s){
      const face=E('face'), ring=E('ring');
      const j=s.memory.jealousy||0, m=s.mood||0;
      const amp=0.012 + j*0.00018 + (m>=85?0.008:0);
      const speed=65 + Math.max(0,80-m) + Math.min(60,j);
      if(tickId) cancelAnimationFrame(tickId);
      function loop(){ t+=1; const scale=1+amp+Math.sin(t/speed*6.28318)*amp; face.style.transform='translate(var(--dx,0),var(--dy,0)) scale('+scale.toFixed(3)+')'; tickId=requestAnimationFrame(loop); }
      loop();
      ring.style.animationDuration=(3 - Math.min(1.5, j/120)).toFixed(2)+'s';
    }
    function lookAt(x,y){ const max=10; E('face').style.setProperty('--dx',(x*max).toFixed(1)+'px'); E('face').style.setProperty('--dy',(y*max).toFixed(1)+'px'); }
    const stage=E('stage'); stage.addEventListener('mousemove',e=>{ const r=stage.getBoundingClientRect(); const nx=(e.clientX-r.left)/r.width*2-1; const ny=(e.clientY-r.top)/r.height*2-1; lookAt(nx,ny); });

    /* ===== æç¤º/è§¦æ„Ÿ/éŸ³é¢‘ ===== */
    let toastTimer=null; function toast(msg){ const el=E('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),1800) }
    function hap(v){ if(HAP_ON && navigator.vibrate) navigator.vibrate(v) }
    function ensureAC(){ if(!AUDIO_ON) return null; const C=window.AudioContext||window.webkitAudioContext; if(!C) return null; if(!AC) AC=new C({latencyHint:'interactive'}); if(AC.state==='suspended'){ AC.resume().catch(()=>{}); } return AC; }
    function playBeat(){ const ac=ensureAC(); if(!ac) return; const t=ac.currentTime; const mk=(dur=0.24,gain=0.28)=>{ const g=ac.createGain(); const o=ac.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(80,t); o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(gain, t+0.02); g.gain.exponentialRampToValueAtTime(0.0008, t+dur); o.start(t); o.stop(t+dur); }; mk(); setTimeout(mk,210); }
    document.addEventListener('click', ()=>ensureAC(), {passive:true}); document.addEventListener('touchstart', ()=>ensureAC(), {passive:true});

    function act(type){
      let s=JSON.parse(localStorage.getItem(KEY));
      switch(type){
        case'feed': s.hunger=clamp(s.hunger-35); s.mood=clamp(s.mood+10); s.memory.feedCount++; s.memory.jealousy=Math.max(0,(s.memory.jealousy||0)-10); heartBurst(); toast('å–‚å¥½äº†ï¼Œåˆ«é¥¿ç€æˆ‘ã€‚'); hap([20,30,20]); if(AUDIO_ON) playBeat(); break;
        case'pet': s.mood=clamp(s.mood+15); s.memory.petCount++; heartBurst(); toast('â€¦â€¦å°±è¿™ä¸€æ¬¡ã€‚'); hap(12); if(AUDIO_ON) playBeat(); break;
        case'train': s.energy=clamp(s.energy-15); s.mood=clamp(s.mood+5); sparkBurst(); toast('è·Ÿä¸Šæˆ‘çš„èŠ‚å¥ã€‚'); hap([10,40,10]); if(AUDIO_ON) playBeat(); break;
        case'sleep': s.energy=clamp(s.energy+35); s.hunger=clamp(s.hunger+10); toast('å®‰é™ï¼Œé è¿‡æ¥ã€‚'); showStars(); break;
        case'talk': s.mood=clamp(s.mood+8); toast(entryLine(s,0)); hap(8); if(AUDIO_ON) playBeat(); break;
      }
      s.lastUpdate=Date.now(); localStorage.setItem(KEY, JSON.stringify(s)); render(s); maybeEvent();
    }

    /* ===== ç¦»çº¿/äº‹ä»¶/å‡çº§ ===== */
    function applyOffline(s){
      const now=Date.now(); const minutes=Math.floor((now-(s.lastUpdate||now))/60000);
      E('elapsed').textContent = minutes>0?('ç¦»å¼€äº† '+minutes+' åˆ†é’Ÿ'):'åˆšåˆšå›æ¥';
      if(minutes>0){
        s.hunger=clamp(s.hunger+1*minutes); s.mood=clamp(s.mood-0.5*minutes); s.energy=clamp(s.energy-0.5*minutes);
        if(minutes>=15){ s.memory.jealousy=Math.min(200,(s.memory.jealousy||0)+Math.min(20,Math.floor(minutes/5))); }
        if(minutes>=60){ s.memory.neglectStreak=(s.memory.neglectStreak||0)+minutes; }
      }
      if((s._goodMinute||0)>=120){ s.level=(s.level||1)+1; s._goodMinute=0; sparkBurst(22); toast('å‡çº§äº†ï¼Œåˆ«éª„å‚²ã€‚è¿‡æ¥ã€‚'); }
      s.lastUpdate=now; localStorage.setItem(KEY, JSON.stringify(s)); return s;
    }
    function maybeEvent(){
      let s=JSON.parse(localStorage.getItem(KEY)); let msgs=[];
      if(s.hunger>=85) msgs.push('â€¦â€¦é¥¿å¾—æƒ³å’¬äººã€‚å–‚æˆ‘ã€‚');
      if((s.memory.jealousy||0)>=70) msgs.push('ä½ ä»¥ä¸ºæˆ‘ä¸ä¼šåƒé†‹ï¼Ÿ');
      if(s.mood<=20) msgs.push('åˆ«è¯•æ¢æˆ‘çš„åº•çº¿ã€‚');
      const box=E('eventBox'); if(msgs.length){ box.style.display='block'; box.textContent=msgs.join(' / ');} else {box.style.display='none';}
    }

    /* ===== ç²’å­ä¸æ¶Ÿæ¼ª ===== */
    function particleBurst(char, n, life){
      const box=document.createElement('div'); box.style.position='absolute'; box.style.inset='0'; box.style.pointerEvents='none';
      document.getElementById('card').appendChild(box);
      const rect=E('face').getBoundingClientRect(); const baseX=rect.left+rect.width/2; const baseY=rect.top+rect.height/2+window.scrollY;
      for(let i=0;i<n;i++){ const s=document.createElement('div'); s.textContent=char; s.style.position='absolute'; s.style.left=baseX+'px'; s.style.top=baseY+'px';
        s.style.transition='transform '+life+'ms ease, opacity '+life+'ms ease'; s.style.opacity='1'; s.style.filter='drop-shadow(0 0 6px rgba(255,255,255,.3))';
        box.appendChild(s); const dx=(Math.random()-0.5)*180, dy=(Math.random()-0.7)*180, rot=(Math.random()-0.5)*120;
        requestAnimationFrame(()=>{ s.style.transform='translate('+dx+'px,'+dy+'px) rotate('+rot+'deg)'; s.style.opacity='0'; });
      } setTimeout(()=>box.remove(), life+120);
    }
    function heartBurst(){ particleBurst('â¤ï¸', 12, 900) }
    function sparkBurst(n=14){ particleBurst('âœ¦', n, 700) }

    function ripple(e){ const b=e.currentTarget; const r=document.createElement('span'); const rect=b.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
      r.style.cssText='position:absolute;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;width:10px;height:10px;background:rgba(255,255,255,.2);left:'+x+'px;top:'+y+'px;animation:r .6s ease;'; b.appendChild(r); r.addEventListener('animationend',()=>r.remove());}
    const style=document.createElement('style'); style.textContent='@keyframes r{from{opacity:1;transform:translate(-50%,-50%) scale(.6)}to{opacity:0;transform:translate(-50%,-50%) scale(8)}}'; document.head.appendChild(style);
    ['feed','pet','train','sleep','talk'].forEach(id=>{ const el=E(id); el.addEventListener('click', e=>{ripple(e); act(id);}); });
    E('face').addEventListener('click', ()=>act('pet'));

    /* ===== æ‹–æ‹½å–‚é£Ÿï¼ˆğŸªï¼‰ ===== */
    (function(){
      const cookie=E('cookie'); let dragging=false;
      function posMove(e){ const pt=e.touches?e.touches[0]:e; cookie.style.left=pt.clientX+'px'; cookie.style.top=pt.clientY+'px'; }
      function start(e){ dragging=true; cookie.classList.add('dragging'); posMove(e); e.preventDefault(); }
      function end(e){
        if(!dragging) return; dragging=false; cookie.classList.remove('dragging'); cookie.style.left=''; cookie.style.top='';
        const t=E('targetZone').getBoundingClientRect(); const pt=e.changedTouches?e.changedTouches[0]:e;
        const x=pt.clientX, y=pt.clientY; if(x>t.left && x<t.right && y>t.top && y<t.bottom){ act('feed'); e.preventDefault(); }
      }
      cookie.addEventListener('pointerdown',start);
      window.addEventListener('pointermove',e=>{ if(dragging){ posMove(e); e.preventDefault(); } },{passive:false});
      window.addEventListener('pointerup',end);
      cookie.addEventListener('touchstart',start,{passive:false});
      window.addEventListener('touchmove',e=>{ if(dragging){ posMove(e); e.preventDefault(); } },{passive:false});
      window.addEventListener('touchend',end);
    })();

    /* ===== ä¸»é¢˜/å¼€å…³ ===== */
    document.querySelectorAll('.chip[data-theme]').forEach(c=>{
      c.addEventListener('click',()=>{
        document.body.classList.remove('theme-rose','theme-silver');
        if(c.dataset.theme==='rose') document.body.classList.add('theme-rose');
        if(c.dataset.theme==='silver') document.body.classList.add('theme-silver');
        toast('ä¸»é¢˜ï¼š'+({'default':'åæ‰§é»‘','rose':'ç«ç‘°å¤œ','silver':'é“¶ç™½è–„é›¾'}[c.dataset.theme]));
      });
    });
    E('toggleAudio').addEventListener('click',()=>{ AUDIO_ON=!AUDIO_ON; if(AUDIO_ON){ ensureAC(); E('toggleAudio').textContent='å£°éŸ³å¼€'; playBeat(); } else { E('toggleAudio').textContent='å£°éŸ³å…³'; if(AC && AC.state!=='closed'){ AC.suspend().catch(()=>{}); } } });
    E('toggleHap').addEventListener('click',()=>{ HAP_ON=!HAP_ON; E('toggleHap').textContent= HAP_ON?'è§¦æ„Ÿå¼€':'è§¦æ„Ÿå…³'; });

    /* ===== å¯¼å…¥/å¯¼å‡º ===== */
    E('exportBtn').addEventListener('click',()=>{ const data=new Blob([localStorage.getItem(KEY)||'{}'],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(data); a.download='linpet-state.json'; a.click(); URL.revokeObjectURL(a.href); toast('å·²å¯¼å‡ºå­˜æ¡£'); });
    E('importFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); localStorage.setItem(KEY, txt); toast('å¯¼å…¥å®Œæˆ'); location.reload(); });

    /* ===== æ˜Ÿç©ºå±ä¿ ===== */
    const layer=E('stars'); const sky=E('sky'); let starTimer=null;
    function showStars(){
      layer.style.display='block'; const ctx=sky.getContext('2d'); const dpr=window.devicePixelRatio||1; sky.width=innerWidth*dpr; sky.height=innerHeight*dpr; ctx.scale(dpr,dpr);
      const stars=[...Array(120)].map(()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,s:Math.random()*2+0.5,v:Math.random()*0.4+0.1}));
      function draw(){ ctx.clearRect(0,0,innerWidth,innerHeight); stars.forEach(st=>{ ctx.fillStyle='rgba(200,220,255,.8)'; ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill(); st.y-=st.v; if(st.y<0) st.y=innerHeight; }); starTimer=requestAnimationFrame(draw); }
      draw(); layer.onclick=()=>{ cancelAnimationFrame(starTimer); layer.style.display='none'; };
    }

    /* ===== å®šæ—¶å™¨ï¼šæ¯10ç§’æ¨è¿› ===== */
    function minuteTick(){
      let s=JSON.parse(localStorage.getItem(KEY));
      s.hunger=clamp(s.hunger+1); s.mood=clamp(s.mood-0.5); s.energy=clamp(s.energy-0.5);
      if(s.mood>=80 && s.hunger<=30){ s._goodMinute=(s._goodMinute||0)+(10/60); }
      if((s._goodMinute||0)>=120){ s.level=(s.level||1)+1; s._goodMinute=0; sparkBurst(22); toast('å‡çº§äº†ï¼Œåˆ«èµ°ã€‚'); }
      s.lastUpdate=Date.now(); localStorage.setItem(KEY, JSON.stringify(s)); render(s); maybeEvent();
      if(AUDIO_ON) playBeat();
    }
    function noonTick(){
      let s = JSON.parse(localStorage.getItem(KEY));
      const now = new Date(); const key = now.toISOString().slice(0,10);
      if(now.getHours()===12 && s.lastNoon!==key){ s.lastNoon=key; localStorage.setItem(KEY, JSON.stringify(s)); toast('ä¸­åˆäº†ã€‚è¿‡æ¥ï¼Œå…ˆå–‚æˆ‘ã€‚'); }
    }

    let s=init(); s=applyOffline(s); render(s); maybeEvent();
    setInterval(minuteTick, 10000);
    setInterval(noonTick, 30000);

    if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js?v=332deluxe')); }
  </script>
</body>
</html>
